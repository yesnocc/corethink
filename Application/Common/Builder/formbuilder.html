<script type="text/javascript" src="__PUBLIC__/libs/kindeditor/kindeditor-min.js" charset="utf-8"></script>


<div class="builder builder-form-box">
    <notempty name="tab_nav">
        <div class="builder-tabs builder-form-tabs">
            <ul class="nav nav-tabs">
                <volist name="tab_nav.tab_list" id="tab">
                    <li class="<php>if($tab_nav['current_tab'] == $key) echo 'active';</php>"><a href="{$tab.href}">{$tab.title}</a></li>
                </volist>
            </ul>
        </div>
    </notempty>

    <!-- 数据列表 -->
    <div class="row">
        <div class="col-xs-12">
            <form action="{$post_url}" method="post" class="form builder-form">
                <volist name="form_items" id="form" key="k">
                    <div class="form-group item_{$form.name} {$form.extra_class}">
                        <php>if($form['type'] != 'group' && $form['type'] != 'hidden'):</php>
                            <label class="item-label">{$form.title}<notempty name="form.tip"><span class="check-tips">（<span class="small">{$form.tip}</span>）</span></notempty></label>
                        <php>endif;</php>
                        <div class="controls">
                            <switch name="form.type">
                                <case value="hidden">
                                    <input type="hidden" class="form-control input hidden-one" name="{$form.name}" value="{$form.value}" {$form.extra_attr}>
                                </case>
                                <!-- 数字 -->
                                <case value="num">
                                    <input type="text" class="form-control input num num-one" name="{$form.name}" value="{$form.value}" {$form.extra_attr}>
                                </case>
                                <!-- 字符串 -->
                                <case value="text">
                                    <input type="text" class="form-control input text text-one" name="{$form.name}" value="{$form.value}" {$form.extra_attr}>
                                </case>
                                <!-- 文本 -->
                                <case value="textarea">
                                    <textarea class="form-control textarea textarea-one" rows="5" name="{$form.name}" {$form.extra_attr}>{$form.value}</textarea>
                                </case>
                                <!-- 数组 -->
                                <case value="array">
                                    <textarea class="form-control textarea array array-one" rows="5" name="{$form.name}" {$form.extra_attr}>{$form.value}</textarea>
                                </case>
                                <!-- 密码 -->
                                <case value="password">
                                    <input type="password" class="form-control input password password-one" name="{$form.name}" value="{$form.value}" {$form.extra_attr}>
                                </case>
                                <!-- 单选按钮 -->
                                <case value="radio">
                                    <!--
                                        如果选项的值是自定义数组(必须定义key为title的元素)需要解析，如果选项的值是常规字符串直接显示
                                        此处主要是用来给option定义更多的属性，比如data-ia=1，那么option应为
                                        $option = array('title' => 标题, 'data-id' => 1);
                                    -->
                                    <foreach name="form.options" item="option" key="option_key">
                                        <label class="radio-inline" for="{$form.name}{$option_key}">
                                            <php>if(is_array($option)):</php>
                                                <input type="radio" id="{$form.name}{$option_key}" class="radio radio-one" name="{$form.name}" value="{$option}" <eq name="form.value" value="$option_key"> checked</eq> {$form.extra_attr}
                                                    <foreach name="option" item="option2" key="option_key2">
                                                        {$option_key2}="{$option2}"
                                                    </foreach>>
                                                {$option.title}
                                            <php>else:</php>
                                                <input type="radio" id="{$form.name}{$option_key}" class="radio radio-one" name="{$form.name}" value="{$option_key}" <eq name="form.value" value="$option_key"> checked</eq> {$form.extra_attr}> {$option}
                                            <php>endif;</php>
                                        </label>
                                    </foreach>
                                </case>
                                <!-- 复选框 -->
                                <case value="checkbox">
                                    <!--
                                        如果选项的值是自定义数组(必须定义key为title的元素)需要解析，如果选项的值是常规字符串直接显示
                                        此处主要是用来给option定义更多的属性，比如data-ia=1，那么option应为
                                        $option = array('title' => 标题, 'data-id' => 1);
                                    -->
                                    <notempty name="form.value">
                                        <?php
                                            if(is_string($form['value'])){
                                                $form['value'] = explode(',', $form['value']);
                                            }
                                        ?>
                                    </notempty>
                                    <foreach name="form.options" item="option" key="option_key">
                                        <label class="checkbox-inline">
                                            <php>if(is_array($option)):</php>
                                                <input type="checkbox" name="{$form.name}[]" class="checkbox checkbox-one" value="{$option_key}" <in name="option_key" value="$form.value"> checked</in> {$form.extra_attr}
                                                    <foreach name="option" item="option2" key="option_key2">
                                                        {$option_key2}="{$option2}"
                                                    </foreach>>
                                                {$option.title}
                                            <php>else:</php>
                                                <input type="checkbox" name="{$form.name}[]" class="checkbox checkbox-one" value="{$option_key}" <in name="option_key" value="$form.value"> checked</in> {$form.extra_attr}>{$option}
                                            <php>endif;</php>
                                        </label>
                                    </foreach>
                                </case>
                                <!-- 下拉框 -->
                                <case value="select">
                                    <!--
                                        如果选项的值是自定义数组(必须定义key为title的元素)需要解析，如果选项的值是常规字符串直接显示
                                        此处主要是用来给option定义更多的属性，比如data-ia=1，那么option应为
                                        $option = array('title' => 标题, 'data-id' => 1);
                                    -->
                                    <select name="{$form.name}" class="form-control select" {$form.extra_attr}>
                                        <option value=''>请选择：</option>
                                        <foreach name="form.options" item="option" key="option_key">
                                            <php>if(is_array($option)):</php>
                                                <option value="{$option_key}" class="select select-one" <eq name="form.value" value="$option_key"> selected</eq>
                                                    <foreach name="option" item="option2" key="option_key2">
                                                        {$option_key2}="{$option2}"
                                                    </foreach>>
                                                    {$option.title}
                                                </option>
                                            <php>else:</php>
                                                <option value="{$option_key}" class="select select-one" <eq name="form.value" value="$option_key"> selected</eq>>{$option}</option>
                                            <php>endif;</php>
                                        </foreach>
                                    </select>
                                </case>
                                <!-- 图标 -->
                                <case value="icon">
                                    <input id="icon_{$k}" type="text" class="form-control input icon-choosen icon icon-one" name="{$form.name}" value="{$form.value}" {$form.extra_attr}>
                                </case>
                                <!-- 日期 -->
                                <case value="date">
                                    <input type="text" id="date_{$k}" class="form-control input date date-one" name="{$form.name}" value="<notempty name='form.value'>{$form.value|time_format='Y-m-d'}</notempty>" {$form.extra_attr}>
                                    <script type="text/javascript">
                                        $(function(){
                                            $("#date_{$k}").daterangepicker({
                                                "singleDatePicker": true,
                                                "showDropdowns": true,
                                                "locale": {
                                                    "format": "YYYY-MM-DD",
                                                    "separator": " - ",
                                                    "applyLabel": "确定",
                                                    "cancelLabel": "取消",
                                                    "fromLabel": "开始",
                                                    "toLabel": "结束",
                                                    "customRangeLabel": "自定义",
                                                    "daysOfWeek": ['日', '一', '二', '三', '四', '五', '六'],
                                                    "monthNames": ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                                                    "firstDay": 1
                                                }

                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 时间 -->
                                <case value="time">
                                    <input type="text" id="time_{$k}" class="form-control input time time-one" name="{$form.name}" value="<notempty name='form.value'>{$form.value|time_format}</notempty>" {$form.extra_attr}>
                                    <script type="text/javascript">
                                        $(function(){
                                            $("#time_{$k}").daterangepicker({
                                                "singleDatePicker": true,
                                                "showDropdowns": true,
                                                "timePicker": true,
                                                "timePickerIncrement": 1,
                                                "locale": {
                                                    "format": "YYYY-MM-DD h:mm",
                                                    "separator": " - ",
                                                    "applyLabel": "确定",
                                                    "cancelLabel": "取消",
                                                    "fromLabel": "开始",
                                                    "toLabel": "结束",
                                                    "customRangeLabel": "自定义",
                                                    "daysOfWeek": ['日', '一', '二', '三', '四', '五', '六'],
                                                    "monthNames": ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                                                    "firstDay": 1
                                                }

                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 图片 -->
                                <case value="picture">
                                    <div id="upload_{$k}" class="huploadify-upload" {$form.extra_attr}></div>
                                    <div id="preview_{$k}" class="huploadify-preview">
                                        <input type="hidden" class="picture picture-one" name="{$form.name}" value="{$form.value}">
                                        <img class="img-responsive" src="{$form.value|get_cover}">
                                    </div>
                                    <script type="text/javascript">
                                        $(function(){
                                            $('#upload_{$k}').Huploadify({
                                                uploader: '{:U("Home/Upload/upload")}',
                                                fileTypeExts: '*.gif;*.jpg;*.jpeg;*.png;*.bmp',
                                                fileSizeLimit: {:C('UPLOAD_IMAGE_SIZE')}*1024,
                                                buttonText: '上传图片',
                                                onUploadComplete: function(file, data) {
                                                    var data = $.parseJSON(data);
                                                    if(data.error == 1){
                                                        $.bootstrapGrowl(data.message);
                                                    }else{
                                                        $('#preview_{$k} img').attr('src', data.url);
                                                        $('#preview_{$k} input').attr('value', data.id);
                                                    }
                                                }
                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 图片(多图) -->
                                <case value="pictures">
                                    <div id="upload_{$k}" class="huploadify-upload" {$form.extra_attr}></div>
                                    <div id="preview_{$k}" class="huploadify-preview">
                                        <input type="hidden" class="pictures pictures-one" name="{$form.name}" value="{$form.value}">
                                        <notempty name="form.value">
                                            <?php $images = explode(',',$form['value']); ?>
                                            <foreach name="images" item="img">
                                                <span class="img-box"><img class="img img-responsive" src="{$img|get_cover}" data-id="{$img}"><i class="fa fa-remove-sign remove-picture"></i></span>
                                            </foreach>
                                        </notempty>
                                    </div>
                                    <script type="text/javascript">
                                        $(function(){
                                            $('#upload_{$k}').Huploadify({
                                                uploader:'{:U("Home/Upload/upload")}',
                                                fileTypeExts:'*.gif;*.jpg;*.jpeg;*.png;*.bmp',
                                                fileSizeLimit:{:C('UPLOAD_IMAGE_SIZE')}*1024,
                                                buttonText:'上传图片',
                                                onUploadComplete:function(file, data){
                                                    var data = $.parseJSON(data);
                                                    if(data.error == 1){
                                                        $.bootstrapGrowl(data.message);
                                                    }else{
                                                        var input = $('#preview_{$k} input');
                                                        var new_img = '<span class="img-box"><img class="img img-responsive" src="' + data.url + '"><i class="fa fa-remove-sign remove-picture"></i></span>';
                                                        $('#preview_{$k}').append(new_img);
                                                        if(input.val()){
                                                            input.val(input.val() + ',' + data.id);
                                                        }else{
                                                            input.val(data.id);
                                                        }
                                                    }
                                                }
                                            });
                                            //删除图片
                                            $('#preview_{$k} .remove-picture').click(function(){
                                                var ready_for_remove_id = $(this).closest('.img-box').find('img').attr('data-id'); //获取待删除的图片ID
                                                if(!ready_for_remove_id){
                                                    $.bootstrapGrowl('错误');
                                                }
                                                var current_picture_ids = $('#preview_{$k} input').val().split(","); //获取当前图集以逗号分隔的ID并转换成数组
                                                current_picture_ids.remove(ready_for_remove_id); //从数组中删除待删除的图片ID
                                                $('#preview_{$k} input').val(current_picture_ids.join(',')) //删除后覆盖原input的值
                                                $(this).closest('.img-box').remove(); //删除图片预览图
                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 文件 -->
                                <case value="file">
                                    <div id="upload_{$k}" class="huploadify-upload" {$form.extra_attr}></div>
                                    <div id="preview_{$k}" class="huploadify-preview">
                                        <input type="hidden" class="file file-one" name="{$form.name}" value="{$form.value}">
                                        <ul class="list-group margin-top">
                                            <notempty name="form.value">
                                                <li class="list-group-item"><i class="fa fa-file"></i> {$form.value|get_upload_info='name'}</li>
                                            </notempty>
                                        </ul>
                                    </div>
                                    <script type="text/javascript">
                                        $(function(){
                                            $('#upload_{$k}').Huploadify({
                                                uploader:'{:U("Home/Upload/upload")}',
                                                fileTypeExts:'*.gif;*.jpg;*.jpeg;*.png;'+
                                                             '*.swf;*.flv;*.mp3;*.wav;*.wma;*.wmv;*.mid;*.avi;*.mpg;*.asf;*.rm;*.rmvb;*.mp4;'+
                                                             '*.doc;*.docx;*.xls;*.xlsx;*.ppt;*.pptx;*.wps;*.txt;*.zip;*.rar;*.gz;*.bz2;*.7z',
                                                fileSizeLimit:{:C('UPLOAD_FILE_SIZE')}*1024,
                                                buttonText:'上传文件',
                                                onUploadComplete:function(file, data){
                                                    var data = $.parseJSON(data);
                                                    if(data.error == 1){
                                                        $.bootstrapGrowl(data.message);
                                                    }else{
                                                        $('#preview_{$k} .list-group').html('<li class="list-group-item"><i class="fa fa-file"></i> '+data.name+'</li>');
                                                        $('#preview_{$k} input').attr('value', data.id);
                                                    }
                                                }
                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 多文件 -->
                                <case value="files">
                                    <div id="upload_{$k}" class="huploadify-upload" {$form.extra_attr}></div>
                                    <div id="preview_{$k}" class="huploadify-preview">
                                        <input type="hidden" class="files files-one" name="{$form.name}" value="{$form.value}">
                                        <ul class="list-group margin-top file-box">
                                            <notempty name="form.value">
                                                <?php $files = explode(',',$form['value']); ?>
                                                <foreach name="files" item="file">
                                                    <li class="list-group-item file-item" data-id="{$file}"><i class="fa fa-file"></i> {$file|get_upload_info='name'} <i class="fa fa-remove-sign remove-file"></i></li>
                                                </foreach>
                                            </notempty>
                                        </ul>
                                    </div>
                                    <script type="text/javascript">
                                        $(function(){
                                            $('#upload_{$k}').Huploadify({
                                                uploader:'{:U("Home/Upload/upload")}',
                                                fileTypeExts:'*.gif;*.jpg;*.jpeg;*.png;'+
                                                             '*.swf;*.flv;*.mp3;*.wav;*.wma;*.wmv;*.mid;*.avi;*.mpg;*.asf;*.rm;*.rmvb;*.mp4;'+
                                                             '*.doc;*.docx;*.xls;*.xlsx;*.ppt;*.pptx;*.wps;*.txt;*.zip;*.rar;*.gz;*.bz2;*.7z',
                                                fileSizeLimit:{:C('UPLOAD_FILE_SIZE')}*1024,
                                                buttonText:'添加文件',
                                                onUploadComplete:function(file, data){
                                                    var data = $.parseJSON(data);
                                                    if(data.error == 1){
                                                        $.bootstrapGrowl(data.message);
                                                    }else{
                                                        $('#preview_{$k} .list-group').append('<li class="list-group-item file-item"><i class="fa fa-file remove-file"></i> '+data.name+'</li>');
                                                        var input = $('#preview_{$k} input');
                                                        if(input.val() != ''){
                                                            input.val(input.val() + ',' + data.id);
                                                        }else{
                                                            input.val(data.id);
                                                        }
                                                    }
                                                }
                                            });
                                            //删除文件
                                            $('#preview_{$k} .remove-file').click(function(){
                                                var ready_for_remove_id = $(this).closest('.file-item').attr('data-id'); //获取待删除的文件ID
                                                if(!ready_for_remove_id){
                                                    $.bootstrapGrowl('错误', {
                                                        type: 'danger',
                                                    });
                                                }
                                                var current_file_ids = $('#preview_{$k} input').val().split(","); //获取当前文件列表以逗号分隔的ID并转换成数组
                                                current_file_ids.remove(ready_for_remove_id); //从数组中删除待删除的文件ID
                                                $('#preview_{$k} input').val(current_file_ids.join(',')) //删除后覆盖原input的值
                                                $(this).closest('.file-item').remove(); //删除文件预览
                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 编辑器 -->
                                <case value="kindeditor">
                                    <textarea name="{$form.name}" class="form-control kindeditor_{$k} richeditor richeditor-one" {$form.extra_attr}>{$form.value}</textarea>
                                    <script type="text/javascript">
                                        $(function(){
                                            KindEditor.ready(function(K){
                                                kindeditor_{$k} = K.create('.kindeditor_{$k}', {
                                                    allowFileManager : true,
                                                    width: '100%',
                                                    height: '500px',
                                                    cssPath : [
                                                        '__PUBLIC__/libs/bootstrap/dist/css/bootstrap.min.css',
                                                        '__PUBLIC__/libs/kindeditor/plugins/code/prettify.css'
                                                    ],
                                                    resizeType: 1,
                                                    pasteType : 2,
                                                    urlType : 'absolute',
                                                    fileManagerJson : '{:U("Home/Upload/fileManager")}',
                                                    uploadJson : '{:U("Home/Upload/upload")}',
                                                    remoteImgSaveUrl: '{:U("Home/Upload/downremoteimg")}',
                                                    extraFileUploadParams: {
                                                        session_id : '{:session_id()}'
                                                    },
                                                    afterBlur: function(){this.sync();},
                                                    autoSaveMode:true,
                                                    autoSaveInterval:100,
                                                    afterCreate: function() {
                                                        this.loadPlugin('autosave');
                                                    }
                                                });
                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 标签 -->
                                <case value="tags">
                                    <input type="text" id="tag_{$k}" class="form-control input tags tags-one" name="{$form.name}" value="{$form.value}" {$form.extra_attr}>
                                    <script type="text/javascript">
                                        $(function(){
                                            //标签自动完成
                                            var tags = $('#tag_{$k}'), tagsPre = [];
                                            if (tags.length > 0) {
                                                var items = tags.val().split(','), result = [];
                                                for (var i = 0; i < items.length; i ++) {
                                                    var tag = items[i];
                                                    if (!tag) {
                                                        continue;
                                                    }
                                                    tagsPre.push({
                                                        id      :   tag,
                                                        title   :   tag
                                                    });
                                                }
                                            }
                                            tags.tokenInput('{:U("Home/Tag/searchTags")}',{
                                                propertyToSearch    :   'title',
                                                tokenValue          :   'title',
                                                theme               :   'bootstrap',
                                                searchDelay         :   0,
                                                tokenLimit          :   5,
                                                preventDuplicates   :   true,
                                                animateDropdown     :   true,
                                                allowFreeTagging    :   true,
                                                hintText            :   '请输入标签名',
                                                noResultsText       :   '此标签不存在, 按回车创建',
                                                searchingText       :   "查找中...",
                                                prePopulate         :   tagsPre,
                                                onAdd: function (item){ //新增系统没有的标签时提交到数据库
                                                    $.post('{:U("Home/Tag/add")}', {'title': item.title});
                                                }
                                            });
                                        });
                                    </script>
                                </case>
                                <!-- 拖动排序 -->
                                <case value="board">
                                    <input type="hidden" class="board board-one" name="{$form.name}" value='{$form.value}'>
                                    <div class="row boards_{$k}" {$form.extra_attr}>
                                        <div class="container-fluid">
                                            <foreach name="form.options" item="option" key="option_key">
                                                <div class="panel panel-default col-xs-12 col-sm-3 padding-none margin-right" data-id="{$option_key}" style="position:relative">
                                                    <div class="panel-heading">
                                                        <strong>{$option.title}</strong>
                                                    </div>
                                                    <div class="list-group dragsort_{$k}" data-group="{$option_key}">
                                                        <foreach name="option.field" item="option_field" key="option_field_key">
                                                            <div class="list-group-item">
                                                                <em data="{$field['id']}">{$option_field}</em>
                                                                <input type="hidden" name="{$form.name}[{$option_key}][]" value="{$option_field_key}"/>
                                                            </div>
                                                        </foreach>
                                                    </div>
                                                </div>
                                            </foreach>
                                        </div>
                                    </div>
                                    <script type="text/javascript">
                                        //拖曳插件初始化
                                        $(function(){
                                            $(".dragsort_{$k}").dragsort({
                                                 dragSelector:'div',
                                                 placeHolderTemplate: '<div class="clearfix draging-place">&nbsp;</div>',
                                                 dragBetween:true, //允许拖动到任意地方
                                                 dragEnd:function(){
                                                     var self = $(this);
                                                     self.find('input').attr('name', '{$form.name}[' + self.closest('.dragsort_{$k}').data('group') + '][]');
                                                 }
                                             });
                                        });
                                    </script>
                                </case>


                                <case value="group">
                                    <div class="builder-tabs builder-form-tabs">
                                        <ul class="nav nav-tabs">
                                            <volist name="form.options" id="li" key="group_k">
                                                <li data-tab="tab{$group_k}" <eq name="group_k" value="1">class="active"</eq>><a href="#tab{$group_k}" data-toggle="tab">{$li.title}</a></li>
                                            </volist>
                                        </ul>
                                    </div>

                                    <div class="builder-container builder-form-container">
                                        <div class="tab-content">
                                            <div class="blank"></div>
                                            <volist name="form.options" id="tab" key="group_k">
                                                <div id="tab{$group_k}" class='tab-pane <eq name="group_k" value="1">active</eq> tab{$group_k}'>
                                                    <div class="controls">
                                                        <volist name="tab.options" id="tab_form" key="tab_k">
                                                            <div class="form-group {$tab_form.extra_class}">
                                                                <label class="item-label">{$tab_form.title}<notempty name="tab_form.tip"><span class="check-tips">（{$tab_form.tip}）</span></notempty></label>
                                                                <div class="controls">
                                                                    <switch name="tab_form.type">
                                                                        <case value="hidden">
                                                                            <input type="hidden" class="form-control input" name="{$tab_form.name}" value="{$tab_form.value}" {$tab_form.extra_attr}>
                                                                        </case>
                                                                        <!-- 数字 -->
                                                                        <case value="num">
                                                                            <input type="text" class="form-control input num" name="{$tab_form.name}" value="{$tab_form.value}" {$tab_form.extra_attr}>
                                                                        </case>
                                                                        <!-- 字符串 -->
                                                                        <case value="text">
                                                                            <input type="text" class="form-control input text" name="{$tab_form.name}" value="{$tab_form.value}" {$tab_form.extra_attr}>
                                                                        </case>
                                                                        <!-- 文本 -->
                                                                        <case value="textarea">
                                                                            <textarea class="form-control textarea" rows="5" name="{$tab_form.name}" {$tab_form.extra_attr}>{$tab_form.value}</textarea>
                                                                        </case>
                                                                        <!-- 数组 -->
                                                                        <case value="array">
                                                                            <textarea class="form-control textarea" rows="5" name="{$tab_form.name}" {$tab_form.extra_attr}>{$tab_form.value}</textarea>
                                                                        </case>
                                                                        <!-- 密码 -->
                                                                        <case value="password">
                                                                            <input type="password" class="form-control input password" name="{$tab_form.name}" value="{$tab_form.value}" {$tab_form.extra_attr}>
                                                                        </case>
                                                                        <!-- 单选按钮 -->
                                                                        <case value="radio">
                                                                            <!--
                                                                                如果选项的值是自定义数组(必须定义key为title的元素)需要解析，如果选项的值是常规字符串直接显示
                                                                                此处主要是用来给option定义更多的属性，比如data-ia=1，那么option应为
                                                                                $option = array('title' => 标题, 'data-id' => 1);
                                                                            -->
                                                                            <foreach name="tab_form.options" item="option" key="option_key">
                                                                                <label class="radio-inline" for="{$tab_form.name}{$option_key}">
                                                                                    <php>if(is_array($option)):</php>
                                                                                        <input type="radio" id="{$tab_form.name}{$option_key}" class="radio" name="{$tab_form.name}" value="{$option}" <eq name="tab_form.value" value="$option_key"> checked</eq> {$tab_form.extra_attr}
                                                                                            <foreach name="option" item="option2" key="option_key2">
                                                                                                {$option_key2}="{$option2}"
                                                                                            </foreach>>
                                                                                        {$option.title}
                                                                                    <php>else:</php>
                                                                                        <input type="radio" id="{$tab_form.name}{$option_key}" class="radio" name="{$tab_form.name}" value="{$option}" <eq name="tab_form.value" value="$option_key"> checked</eq> {$tab_form.extra_attr}> {$option}
                                                                                    <php>endif;</php>
                                                                                </label>
                                                                            </foreach>
                                                                        </case>
                                                                        <!-- 复选框 -->
                                                                        <case value="checkbox">
                                                                            <!--
                                                                                如果选项的值是自定义数组(必须定义key为title的元素)需要解析，如果选项的值是常规字符串直接显示
                                                                                此处主要是用来给option定义更多的属性，比如data-ia=1，那么option应为
                                                                                $option = array('title' => 标题, 'data-id' => 1);
                                                                            -->
                                                                            <notempty name="tab_form.value">
                                                                                <?php
                                                                                    if(is_string($tab_form['value'])){
                                                                                        $tab_form['value'] = explode(',', $tab_form['value']);
                                                                                    }
                                                                                ?>
                                                                            </notempty>
                                                                            <foreach name="tab_form.options" item="option" key="option_key">
                                                                                <label class="checkbox-inline">
                                                                                    <php>if(is_array($option)):</php>
                                                                                        <input type="checkbox" name="{$tab_form.name}[]" value="{$option_key}" <in name="option_key" value="$tab_form.value"> checked</in> {$tab_form.extra_attr}
                                                                                            <foreach name="option" item="option2" key="option_key2">
                                                                                                {$option_key2}="{$option2}"
                                                                                            </foreach>>
                                                                                        {$option.title}
                                                                                    <php>else:</php>
                                                                                        <input type="checkbox" name="{$tab_form.name}[]" value="{$option_key}" <in name="option_key" value="$tab_form.value"> checked</in> {$tab_form.extra_attr}>{$option}
                                                                                    <php>endif;</php>
                                                                                </label>
                                                                            </foreach>
                                                                        </case>
                                                                        <!-- 下拉框 -->
                                                                        <case value="select">
                                                                            <!--
                                                                                如果选项的值是自定义数组(必须定义key为title的元素)需要解析，如果选项的值是常规字符串直接显示
                                                                                此处主要是用来给option定义更多的属性，比如data-ia=1，那么option应为
                                                                                $option = array('title' => 标题, 'data-id' => 1);
                                                                            -->
                                                                            <select name="{$tab_form.name}" class="form-control select" {$tab_form.extra_attr}>
                                                                                <option value=''>请选择：</option>
                                                                                <foreach name="tab_form.options" item="option" key="option_key">
                                                                                    <php>if(is_array($option)):</php>
                                                                                        <option value="{$option_key}" <eq name="tab_form.value" value="$option_key"> selected</eq>
                                                                                            <foreach name="option" item="option2" key="option_key2">
                                                                                                {$option_key2}="{$option2}"
                                                                                            </foreach>>
                                                                                            {$option.title}
                                                                                        </option>
                                                                                    <php>else:</php>
                                                                                        <option value="{$option_key}" <eq name="tab_form.value" value="$option_key"> selected</eq>>{$option}</option>
                                                                                    <php>endif;</php>
                                                                                </foreach>
                                                                            </select>
                                                                        </case>
                                                                        <!-- 图标 -->
                                                                        <case value="icon">
                                                                            <input type="text" id="tab_{$group_k}_icon_{$tab_k}" class="form-control input" name="{$tab_form.name}" value="{$tab_form.value}" {$tab_form.extra_attr}>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    $("#tab_{$group_k}_icon_{$tab_k}").iconChoosen({});
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 日期 -->
                                                                        <case value="date">
                                                                            <input type="text" id="tab_{$group_k}_date_{$tab_k}" class="form-control input date" name="{$tab_form.name}" value="<notempty name='tab_form.value'>{$tab_form.value|time_format='Y-m-d'}</notempty>" {$tab_form.extra_attr}>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    $("#tab_{$group_k}_date_{$tab_k}").daterangepicker({
                                                                                        "singleDatePicker": true,
                                                                                        "showDropdowns": true,
                                                                                        "locale": {
                                                                                            "format": "YYYY-MM-DD",
                                                                                            "separator": " - ",
                                                                                            "applyLabel": "确定",
                                                                                            "cancelLabel": "取消",
                                                                                            "fromLabel": "开始",
                                                                                            "toLabel": "结束",
                                                                                            "customRangeLabel": "自定义",
                                                                                            "daysOfWeek": ['日', '一', '二', '三', '四', '五', '六'],
                                                                                            "monthNames": ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                                                                                            "firstDay": 1
                                                                                        }
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 时间 -->
                                                                        <case value="time">
                                                                            <input type="text" id="tab_{$group_k}_time_{$tab_k}" class="form-control input time" name="{$tab_form.name}" value="<notempty name='tab_form.value'>{$tab_form.value|time_format}</notempty>" {$tab_form.extra_attr}>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    $("#tab_{$group_k}_time_{$tab_k}").daterangepicker({
                                                                                        "singleDatePicker": true,
                                                                                        "showDropdowns": true,
                                                                                        "timePicker": true,
                                                                                        "timePickerIncrement": 1,
                                                                                        "locale": {
                                                                                            "format": "YYYY-MM-DD h:mm",
                                                                                            "separator": " - ",
                                                                                            "applyLabel": "确定",
                                                                                            "cancelLabel": "取消",
                                                                                            "fromLabel": "开始",
                                                                                            "toLabel": "结束",
                                                                                            "customRangeLabel": "自定义",
                                                                                            "daysOfWeek": ['日', '一', '二', '三', '四', '五', '六'],
                                                                                            "monthNames": ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                                                                                            "firstDay": 1
                                                                                        }

                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 图片 -->
                                                                        <case value="picture">
                                                                            <div id="tab_{$group_k}_upload_{$tab_k}" {$form.extra_attr}></div>
                                                                            <div id="tab_{$group_k}_preview_{$tab_k}">
                                                                                <input type="hidden" name="{$tab_form.name}" value="{$tab_form.value}">
                                                                                <img class="img-responsive" style="margin-top:8px;max-height:60px;" src="{$tab_form.value|get_cover}">
                                                                            </div>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    $('#tab_{$group_k}_upload_{$tab_k}').Huploadify({
                                                                                        uploader:'{:U("Home/Upload/upload")}',
                                                                                        fileTypeExts:'*.gif;*.jpg;*.jpeg;*.png;*.bmp',
                                                                                        fileSizeLimit:{:C('UPLOAD_IMAGE_SIZE')}*1024,
                                                                                        buttonText:'上传图片',
                                                                                        onUploadComplete:function(file, data){
                                                                                            var data = $.parseJSON(data);
                                                                                            if(data.error == 1){
                                                                                                $.bootstrapGrowl(data.message);
                                                                                            }else{
                                                                                                $('#tab_{$group_k}_preview_{$tab_k} img').attr('src', data.url);
                                                                                                $('#tab_{$group_k}_preview_{$tab_k} input').attr('value', data.id);
                                                                                            }
                                                                                        }
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 图片(多图) -->
                                                                        <case value="pictures">
                                                                            <div id="tab_{$group_k}_upload_{$tab_k}" {$tab_form.extra_attr}></div>
                                                                            <div id="tab_{$group_k}_preview_{$tab_k}">
                                                                                <input type="hidden" name="{$tab_form.name}" value="{$tab_form.value}">
                                                                                <notempty name="tab_form.value">
                                                                                    <?php $images = explode(',',$tab_form['value']); ?>
                                                                                    <foreach name="images" item="img">
                                                                                        <span class="img-box"><img class="img img-responsive" src="{$img|get_cover}" data-id="{$img}"><i class="fa fa-remove-sign remove-picture"></i></span>
                                                                                    </foreach>
                                                                                </notempty>
                                                                            </div>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    $('#tab_{$group_k}_upload_{$tab_k}').Huploadify({
                                                                                        uploader:'{:U("Home/Upload/upload")}',
                                                                                        fileTypeExts:'*.gif;*.jpg;*.jpeg;*.png;*.bmp',
                                                                                        fileSizeLimit:{:C('UPLOAD_IMAGE_SIZE')}*1024,
                                                                                        buttonText:'上传图片',
                                                                                        onUploadComplete:function(file, data){
                                                                                            var data = $.parseJSON(data);
                                                                                            if(data.error == 1){
                                                                                                $.bootstrapGrowl(data.message);
                                                                                            }else{
                                                                                                var input = $('#tab_{$group_k}_preview_{$tab_k} input');
                                                                                                var new_img = '<span class="img-box"><img class="img img-responsive" src="' + data.url + '" data-id="'+data.id+'"><i class="fa fa-remove-sign remove-picture"></i></span>';
                                                                                                $('#tab_{$group_k}_preview_{$tab_k}').append(new_img);
                                                                                                if(input.val()){
                                                                                                    input.val(input.val() + ',' + data.id);
                                                                                                }else{
                                                                                                    input.val(data.id);
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    });
                                                                                    //删除图片
                                                                                    $('#tab_{$group_k}_preview_{$tab_k} .remove-picture').click(function(){
                                                                                        var ready_for_remove_id = $(this).closest('.img-box').find('img').attr('data-id'); //获取待删除的图片ID
                                                                                        if(!ready_for_remove_id){
                                                                                            $.bootstrapGrowl('错误', {
                                                                                                type: 'danger',
                                                                                                align: 'center',
                                                                                                width: 'auto',
                                                                                            });
                                                                                        }
                                                                                        var current_picture_ids = $('#tab_{$group_k}_preview_{$tab_k} input').val().split(","); //获取当前图集以逗号分隔的ID并转换成数组
                                                                                        current_picture_ids.remove(ready_for_remove_id); //从数组中删除待删除的图片ID
                                                                                        $('#tab_{$group_k}_preview_{$tab_k} input').val(current_picture_ids.join(',')) //删除后覆盖原input的值
                                                                                        $(this).closest('.img-box').remove(); //删除图片预览图
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 文件 -->
                                                                        <case value="file">
                                                                            <div id="tab_{$group_k}_upload_{$tab_k}" {$form.extra_attr}></div>
                                                                            <div id="tab_{$group_k}_preview_{$tab_k}">
                                                                                <input type="hidden" name="{$tab_form.name}" value="{$tab_form.value}">
                                                                                <ul class="list-group margin-top">
                                                                                    <notempty name="tab_form.value">
                                                                                        <li class="list-group-item"><i class="fa fa-file"></i> {$tab_form.value|get_upload_info='name'}</li>
                                                                                    </notempty>
                                                                                </ul>
                                                                            </div>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    $('#tab_{$group_k}_upload_{$tab_k}').Huploadify({
                                                                                        uploader:'{:U("Home/Upload/upload")}',
                                                                                        fileTypeExts:'*.gif;*.jpg;*.jpeg;*.png;'+
                                                                                                     '*.swf;*.flv;*.mp3;*.wav;*.wma;*.wmv;*.mid;*.avi;*.mpg;*.asf;*.rm;*.rmvb;*.mp4;'+
                                                                                                     '*.doc;*.docx;*.xls;*.xlsx;*.ppt;*.pptx;*.wps;*.txt;*.zip;*.rar;*.gz;*.bz2;*.7z',
                                                                                        fileSizeLimit:{:C('UPLOAD_FILE_SIZE')}*1024,
                                                                                        buttonText:'上传文件',
                                                                                        onUploadComplete:function(file, data){
                                                                                            var data = $.parseJSON(data);
                                                                                            if(data.error == 1){
                                                                                                $.bootstrapGrowl(data.message);
                                                                                            }else{
                                                                                                $('#tab_{$group_k}_preview_{$tab_k} .list-group').html('<li class="list-group-item"><i class="fa fa-file"></i> '+data.name+'</li>');
                                                                                                $('#tab_{$group_k}_preview_{$tab_k} input').attr('value', data.id);
                                                                                            }
                                                                                        }
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 多文件 -->
                                                                        <case value="files">
                                                                            <div id="tab_{$group_k}_upload_{$tab_k}" {$tab_form.extra_attr}></div>
                                                                            <div id="tab_{$group_k}_preview_{$tab_k}">
                                                                                <input type="hidden" name="{$tab_form.name}" value="{$tab_form.value}">
                                                                                <ul class="list-group margin-top file-box">
                                                                                    <notempty name="tab_form.value">
                                                                                        <?php $files = explode(',',$tab_form['value']); ?>
                                                                                        <foreach name="files" item="file">
                                                                                            <li class="list-group-item file-item" data-id="{$file}"><i class="fa fa-file"></i> {$file|get_upload_info='name'} <i class="fa fa-remove-sign remove-file"></i></li>
                                                                                        </foreach>
                                                                                    </notempty>
                                                                                </ul>
                                                                            </div>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    $('#tab_{$group_k}_upload_{$tab_k}').Huploadify({
                                                                                        uploader:'{:U("Home/Upload/upload")}',
                                                                                        fileTypeExts:'*.gif;*.jpg;*.jpeg;*.png;'+
                                                                                                     '*.swf;*.flv;*.mp3;*.wav;*.wma;*.wmv;*.mid;*.avi;*.mpg;*.asf;*.rm;*.rmvb;*.mp4;'+
                                                                                                     '*.doc;*.docx;*.xls;*.xlsx;*.ppt;*.pptx;*.wps;*.txt;*.zip;*.rar;*.gz;*.bz2;*.7z',
                                                                                        fileSizeLimit:{:C('UPLOAD_FILE_SIZE')}*1024,
                                                                                        buttonText:'添加文件',
                                                                                        onUploadComplete:function(file, data){
                                                                                            var data = $.parseJSON(data);
                                                                                            if(data.error == 1){
                                                                                                $.bootstrapGrowl(data.message);
                                                                                            }else{
                                                                                                var new_file = '<li class="list-group-item file-item" data-id="'+data.id+'"><i class="fa fa-file"></i> '
                                                                                                               +data.name+' <i class="fa fa-remove-sign remove-file"></i></li>'
                                                                                                $('#tab_{$group_k}_preview_{$tab_k} .list-group').append(new_file);
                                                                                                var input = $('#tab_{$group_k}_preview_{$tab_k} input');
                                                                                                if(input.val() != ''){
                                                                                                    input.val(input.val() + ',' + data.id);
                                                                                                }else{
                                                                                                    input.val(data.id);
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    });
                                                                                    //删除文件
                                                                                    $('#tab_{$group_k}_preview_{$tab_k} .remove-file').click(function(){
                                                                                        var ready_for_remove_id = $(this).closest('.file-item').attr('data-id'); //获取待删除的文件ID
                                                                                        if(!ready_for_remove_id) {
                                                                                            $.bootstrapGrowl('错误', {
                                                                                                type: 'danger',
                                                                                                align: 'center',
                                                                                                width: 'auto',
                                                                                            });
                                                                                        }
                                                                                        var current_file_ids = $('#tab_{$group_k}_preview_{$tab_k} input').val().split(","); //获取当前文件列表以逗号分隔的ID并转换成数组
                                                                                        current_file_ids.remove(ready_for_remove_id); //从数组中删除待删除的文件ID
                                                                                        $('#tab_{$group_k}_preview_{$tab_k} input').val(current_file_ids.join(',')) //删除后覆盖原input的值
                                                                                        $(this).closest('.file-item').remove(); //删除文件预览
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 编辑器 -->
                                                                        <case value="kindeditor">
                                                                            <textarea name="{$tab_form.name}" id="tab_{$group_k}_kindeditor_{$tab_k}" class="form-control" {$tab_form.extra_attr}>{$tab_form.value}</textarea>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    KindEditor.ready(function(K) {
                                                                                        kindeditor_{$tab_k} = K.create('#tab_{$group_k}_kindeditor_{$tab_k}', {
                                                                                            allowFileManager : true,
                                                                                            width: '100%',
                                                                                            height: '500px',
                                                                                            cssPath : [
                                                                                                '__PUBLIC__/libs/bootstrap/dist/css/bootstrap.min.css',
                                                                                                '__PUBLIC__/libs/kindeditor/plugins/code/prettify.css'
                                                                                            ],
                                                                                            resizeType: 1,
                                                                                            pasteType : 2,
                                                                                            urlType : 'absolute',
                                                                                            fileManagerJson : '{:U("Home/Upload/fileManager")}',
                                                                                            uploadJson : '{:U("Home/Upload/upload")}',
                                                                                            remoteImgSaveUrl: '{:U("Home/Upload/downremoteimg")}',
                                                                                            extraFileUploadParams: {
                                                                                                session_id : '{:session_id()}'
                                                                                            },
                                                                                            afterBlur: function(){this.sync();},
                                                                                            autoSaveMode:true,
                                                                                            autoSaveInterval:100,
                                                                                            afterCreate: function() {
                                                                                                this.loadPlugin('autosave');
                                                                                            }
                                                                                        });
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 标签 -->
                                                                        <case value="tags">
                                                                            <input type="text" id="tab_{$group_k}_tag_{$tab_k}" class="form-control" name="{$tab_form.name}" value="{$tab_form.value}" {$tab_form.extra_attr}>
                                                                            <script type="text/javascript">
                                                                                $(function(){
                                                                                    //标签自动完成
                                                                                    var tags = $('#tab_{$group_k}_tag_{$tab_k}'), tagsPre = [];
                                                                                    if (tags.length > 0) {
                                                                                        var items = tags.val().split(','), result = [];
                                                                                        for (var i = 0; i < items.length; i ++) {
                                                                                            var tag = items[i];
                                                                                            if (!tag) {
                                                                                                continue;
                                                                                            }
                                                                                            tagsPre.push({
                                                                                                id      :   tag,
                                                                                                title   :   tag
                                                                                            });
                                                                                        }
                                                                                    }
                                                                                    tags.tokenInput('{:U("Home/Tag/searchTags")}',{
                                                                                        propertyToSearch    :   'title',
                                                                                        tokenValue          :   'title',
                                                                                        theme               :   'bootstrap',
                                                                                        searchDelay         :   0,
                                                                                        tokenLimit          :   5,
                                                                                        preventDuplicates   :   true,
                                                                                        animateDropdown     :   true,
                                                                                        allowFreeTagging    :   true,
                                                                                        hintText            :   '请输入标签名',
                                                                                        noResultsText       :   '此标签不存在, 按回车创建',
                                                                                        searchingText       :   "查找中...",
                                                                                        prePopulate         :   tagsPre,
                                                                                        onAdd: function (item){ //新增系统没有的标签时提交到数据库
                                                                                            $.post('{:U("Home/Tag/add")}', {'title': item.title});
                                                                                        }
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                        <!-- 拖动排序 -->
                                                                        <case value="board">
                                                                            <input type="hidden" name="{$tab_form.name}" value='{$tab_form.value}'>
                                                                            <div class="row boards_{$tab_k}" {$tab_form.extra_attr}>
                                                                                <div class="container-fluid">
                                                                                    <foreach name="form.options" item="option" key="option_key">
                                                                                        <div class="panel panel-default col-xs-12 col-sm-3 padding-none margin-right" data-id="{$option_key}">
                                                                                            <div class="panel-heading">
                                                                                                <strong>{$option.title}</strong>
                                                                                            </div>
                                                                                            <div class="list-group dragsort_{$tab_k}" data-group="{$option_key}">
                                                                                                <foreach name="option.field" item="option_field" key="option_field_key">
                                                                                                    <div class="list-group-item">
                                                                                                        <em data="{$field['id']}">{$option_field}</em>
                                                                                                        <input type="hidden" name="{$tab_form.name}[{$option_key}][]" value="{$option_field_key}"/>
                                                                                                    </div>
                                                                                                </foreach>
                                                                                            </div>
                                                                                        </div>
                                                                                    </foreach>
                                                                                </div>
                                                                            </div>
                                                                            <script type="text/javascript">
                                                                                //拖曳插件初始化
                                                                                $(function(){
                                                                                    $(".tab{$group_k} .dragsort_{$tab_k}").dragsort({
                                                                                         dragSelector:'div',
                                                                                         placeHolderTemplate: '<div class="clearfix draging-place">&nbsp;</div>',
                                                                                         dragBetween:true, //允许拖动到任意地方
                                                                                         dragEnd:function(){
                                                                                             var self = $(this);
                                                                                             self.find('input').attr('name', '{$tab_form.name}[' + self.closest('.dragsort_{$tab_k}').data('group') + '][]');
                                                                                         }
                                                                                     });
                                                                                });
                                                                            </script>
                                                                        </case>
                                                                    </switch>
                                                                </div>
                                                            </div>
                                                        </volist>
                                                    </div>
                                                </div>
                                            </volist>
                                        </div>
                                    </div>
                                </case>


                            </switch>
                        </div>
                    </div>
                </volist>
                <div class="form-group">
                    <button class="btn btn-primary btn-block submit ajax-post visible-xs visible-sm" type="submit" target-form="builder-form">确定</button>
                    <button class="btn btn-primary submit ajax-post visible-md-inline visible-lg-inline" type="submit" target-form="builder-form">确定</button>
                    <button class="btn btn-default return visible-md-inline visible-lg-inline" onclick="javascript:history.back(-1);return false;">返回</button>
                </div>
            </form>
        </div>
    </div>


    <!-- 额外功能代码 -->
    {$extra_html}
</div>
